<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <meta name="description" content="Snap for Beginners : Sample Chapter: Digestive Functors (Form Processing)" />

  <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

  <title>Snap for Beginners</title>
</head>

<body>
  <!-- HEADER -->
  <div id="header_wrap" class="outer">
    <header class="inner">
      <a id="forkme_banner" href="https://gumroad.com/l/qWMnO">I Want This (Order)</a>

      <h1 id="project_title">Snap for Beginners</h1>
      <h2 id="project_tagline">Sample Chapter: Digestive Functors (Form Processing)</h2>

    </header>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main_content_wrap" class="outer">
    <section id="main_content" class="inner">
<article class="markdown-body entry-content">
        <h1>
<a name="snaplet-postgresql-simple" class="anchor" href="#snaplet-postgresql-simple"><span class="octicon octicon-link"></span></a>Snaplet PostgreSQL Simple</h1>

<p>Snaplet PostgreSQL Simple offers a connection to the PostgreSQL database via the PostgreSQL Simple package.</p>

<h2>
<a name="basics" class="anchor" href="#basics"><span class="octicon octicon-link"></span></a>Basics</h2>

<p>Before installing <code>snaplet-postgresql-simple</code> you must have postgres installed on your system. Specifically, <code>pg_config</code> must be available on your path, which can come in <code>postgresql-devel</code>, <code>libpq-dev</code> or <code>postgresql</code> depending on your operating system of choice.</p>

<h3>
<a name="add-to-cabal" class="anchor" href="#add-to-cabal"><span class="octicon octicon-link"></span></a>Add to .cabal</h3>

<div class="highlight highlight-haskell"><pre>  <span class="kt">Build</span><span class="o">-</span><span class="n">depends</span><span class="kt">:</span>
    <span class="n">bytestring</span>                <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="o">.</span><span class="mi">1</span>   <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.11</span><span class="p">,</span>
    <span class="n">heist</span>                     <span class="o">&gt;=</span> <span class="mf">0.13</span>    <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.14</span><span class="p">,</span>
    <span class="kt">MonadCatchIO</span><span class="o">-</span><span class="n">transformers</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="o">.</span><span class="mi">1</span>   <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">,</span>
    <span class="n">mtl</span>                       <span class="o">&gt;=</span> <span class="mi">2</span>       <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">snap</span>                      <span class="o">&gt;=</span> <span class="mf">0.13</span>    <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.14</span><span class="p">,</span>
    <span class="n">snap</span><span class="o">-</span><span class="n">core</span>                 <span class="o">&gt;=</span> <span class="mf">0.9</span>     <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.11</span><span class="p">,</span>
    <span class="n">snap</span><span class="o">-</span><span class="n">server</span>               <span class="o">&gt;=</span> <span class="mf">0.9</span>     <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.11</span><span class="p">,</span>
    <span class="n">snap</span><span class="o">-</span><span class="n">loader</span><span class="o">-</span><span class="n">static</span>        <span class="o">&gt;=</span> <span class="mf">0.9</span>     <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.10</span><span class="p">,</span>
    <span class="n">text</span>                      <span class="o">&gt;=</span> <span class="mf">0.11</span>    <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">,</span>
    <span class="n">time</span>                      <span class="o">&gt;=</span> <span class="mf">1.1</span>     <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="n">xmlhtml</span>                   <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">snaplet</span><span class="o">-</span><span class="n">postgresql</span><span class="o">-</span><span class="n">simple</span> <span class="o">&gt;=</span> <span class="mf">0.4</span>     <span class="o">&amp;&amp;</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
</pre></div>

<h3>
<a name="adding-to-app" class="anchor" href="#adding-to-app"><span class="octicon octicon-link"></span></a>Adding to App</h3>

<p>We need to import the snaplet:</p>

<div class="highlight highlight-haskell"><pre><span class="kr">import</span> <span class="nn">Snap.Snaplet.PostgresqlSimple</span>
</pre></div>

<p>and then we can add <code>snaplet-postgresql-simple</code> to our app definition as such.</p>

<div class="highlight highlight-haskell"><pre><span class="kr">data</span> <span class="kt">App</span> <span class="ow">=</span> <span class="kt">App</span>
    <span class="p">{</span> <span class="n">_heist</span> <span class="ow">::</span> <span class="kt">Snaplet</span> <span class="p">(</span><span class="kt">Heist</span> <span class="kt">App</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">_sess</span> <span class="ow">::</span> <span class="kt">Snaplet</span> <span class="kt">SessionManager</span>
    <span class="p">,</span> <span class="n">_db</span> <span class="ow">::</span> <span class="kt">Snaplet</span> <span class="kt">Postgres</span>
    <span class="p">,</span> <span class="n">_auth</span> <span class="ow">::</span> <span class="kt">Snaplet</span> <span class="p">(</span><span class="kt">AuthManager</span> <span class="kt">App</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>

<h3>
<a name="initialization" class="anchor" href="#initialization"><span class="octicon octicon-link"></span></a>Initialization</h3>

<p>We need to add Postgres to our app initialization:</p>

<div class="highlight highlight-haskell"><pre><span class="nf">app</span> <span class="ow">::</span> <span class="kt">SnapletInit</span> <span class="kt">App</span> <span class="kt">App</span>
<span class="nf">app</span> <span class="ow">=</span> <span class="n">makeSnaplet</span> <span class="s">"app"</span> <span class="s">"An snaplet example application."</span> <span class="kt">Nothing</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">h</span> <span class="ow">&lt;-</span> <span class="n">nestSnaplet</span> <span class="s">""</span> <span class="n">heist</span> <span class="o">$</span> <span class="n">heistInit</span> <span class="s">"templates"</span>
    <span class="n">s</span> <span class="ow">&lt;-</span> <span class="n">nestSnaplet</span> <span class="s">"sess"</span> <span class="n">sess</span> <span class="o">$</span>
           <span class="n">initCookieSessionManager</span> <span class="s">"site_key.txt"</span> <span class="s">"sess"</span> <span class="p">(</span><span class="kt">Just</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="n">d</span> <span class="ow">&lt;-</span> <span class="n">nestSnaplet</span> <span class="s">"db"</span> <span class="n">db</span> <span class="n">pgsInit</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">nestSnaplet</span> <span class="s">"auth"</span> <span class="n">auth</span> <span class="o">$</span>
           <span class="n">initJsonFileAuthManager</span> <span class="n">defAuthSettings</span> <span class="n">sess</span> <span class="s">"users.json"</span>
    <span class="n">addRoutes</span> <span class="n">routes</span>
    <span class="n">addAuthSplices</span> <span class="n">h</span> <span class="n">auth</span>
    <span class="n">return</span> <span class="o">$</span> <span class="kt">App</span> <span class="n">h</span> <span class="n">s</span> <span class="n">d</span> <span class="n">a</span>
</pre></div>

<p>The important parts to note are the inclusion of an additional <code>nestSnaplet</code> call for the database and the inclusion of the initialized Snaplet in the returned <code>App</code> value.</p>

<div class="highlight highlight-haskell"><pre><span class="nf">d</span> <span class="ow">&lt;-</span> <span class="n">nestSnaplet</span> <span class="s">"db"</span> <span class="n">db</span> <span class="n">pgsInit</span>
<span class="c1">-- and</span>
<span class="nf">return</span> <span class="o">$</span> <span class="kt">App</span> <span class="n">h</span> <span class="n">s</span> <span class="n">d</span> <span class="n">a</span>
</pre></div>

<h3>
<a name="configuration" class="anchor" href="#configuration"><span class="octicon octicon-link"></span></a>Configuration</h3>

<p>By default, Snaplets create their filesystem on first run of the application <em>if there are no files already there</em>. The Postgres files live in <code>snaplets/postgresql-simple/devel.cfg</code> and look like this by default:</p>

<div class="highlight highlight-haml"><pre>host = "localhost"
port = 5432
user = "postgres"
pass = ""
db = "testdb"

# Nmuber of distinct connection pools to maintain.  The smallest acceptable
# value is 1.
numStripes = 1

# Number of seconds an unused resource is kept open.  The smallest acceptable
# value is 0.5 seconds.
idleTime = 5

# Maximum number of resources to keep open per stripe.  The smallest
# acceptable value is 1.
maxResourcesPerStripe = 20
</pre></div>

<p>Customize this file to adjust connection preferences and other options.</p>

<h3>
<a name="instances" class="anchor" href="#instances"><span class="octicon octicon-link"></span></a>Instances</h3>

<p>Instead of typing <code>with db</code> like we do when we need to use the Auth Snaplet, we can write an instance of <code>HasPostgres</code>, just like we did with Heist. From <code>src/Site.hs</code>:</p>

<div class="highlight highlight-haskell"><pre><span class="kr">instance</span> <span class="kt">HasPostgres</span> <span class="p">(</span><span class="kt">Handler</span> <span class="n">b</span> <span class="kt">App</span><span class="p">)</span> <span class="kr">where</span>
    <span class="n">getPostgresState</span> <span class="ow">=</span> <span class="n">with</span> <span class="n">db</span> <span class="n">get</span>
</pre></div>

<p>To write this instance we need to import <code>get</code> from <code>Control.Monad.State.Class</code>:</p>

<div class="highlight highlight-haskell"><pre><span class="kr">import</span> <span class="nn">Control.Monad.State.Class</span>
</pre></div>

<h3>
<a name="psql" class="anchor" href="#psql"><span class="octicon octicon-link"></span></a>psql</h3>

<p>Since the defaults are a role of <code>postgres</code> and a database <code>testdb</code>, you may need to run these commands in <code>psql</code> to set up Postgres.</p>

<div class="highlight highlight-psql"><pre><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">postgres</span> <span class="n">LOGIN</span><span class="p">;</span>
<span class="go">CREATE DATABASE testdb;</span>
</pre></div>

<h2>
<a name="querying" class="anchor" href="#querying"><span class="octicon octicon-link"></span></a>Querying</h2>

<h3>
<a name="query" class="anchor" href="#query"><span class="octicon octicon-link"></span></a>query</h3>

<p>We can use the already set up tables for the auth snaplet (if we are using the Postgres backend) to see an example query.</p>

<div class="highlight highlight-haskell"><pre><span class="nf">getFromPostgres</span> <span class="ow">::</span> <span class="kt">Handler</span> <span class="kt">App</span> <span class="p">(</span><span class="kt">AuthManager</span> <span class="kt">App</span><span class="p">)</span> <span class="nb">()</span>
<span class="nf">getFromPostgres</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">results</span> <span class="ow">&lt;-</span> <span class="n">query_</span> <span class="s">"select * from snap_auth_user"</span>
    <span class="n">writeJSON</span> <span class="p">(</span><span class="n">results</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">AuthUser</span><span class="p">])</span>
</pre></div>
      </article>
      <!-- FOOTER  -->
      <div id="footer_wrap" class="outer">
        <footer class="inner">
          <p class="copyright">Snap for Beginners maintained by <a href="https://github.com/ChristopherBiscardi">ChristopherBiscardi</a></p>
        </footer>
      </div>

      <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script>
      <script type="text/javascript">
        try {
          var pageTracker = _gat._getTracker("UA-46878058-2");
          pageTracker._trackPageview();
        } catch(err) {}
      </script>


    </body>
    </html>
